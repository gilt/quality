@(org: com.gilt.quality.models.Organization,
  incident: com.gilt.quality.models.Incident,
  plan: Option[com.gilt.quality.models.Plan],
  meetings: Seq[com.gilt.quality.models.Meeting],
  contextOption: Option[lib.IncidentContext]
)(implicit flash: Flash)

@main(org = Some(org), title = s"#${incident.id}: ${incident.summary}") {

  @contextOption.map { context =>
    <ul class="pager">
      <li><a href="@routes.Meetings.show(org.key, context.meeting.id)">Back to Meeting</a></li>
      @context.previousId.map { previousId =>
        <li><a href="@routes.Incidents.show(org.key, incident.id, Some(previousId))">Previous</a></li>
      }
      @context.nextId.map { nextId =>
        <li><a href="@routes.Incidents.show(org.key, incident.id, Some(nextId))">Next</a></li>
      }
    </ul>
  }

  <ul>
    <li>Team: 
        @if(incident.team.isEmpty) {
          <em>None</em>
        } else {
          <a href="@routes.Teams.show(org.key, incident.team.get.key)">@incident.team.get.key</a>
        }
    </li>
    <li>Severity: @incident.severity</li>
    <li>Tags:
      @if(incident.tags.isEmpty) {
        <em>N/A</em>
      } else {
        @Html(incident.tags.mkString("<ul><li>", "</li><li>", "</li></ul>"))
      }
    </li>
    <li>Created: @_root_.org.joda.time.format.DateTimeFormat.longDateTime.print(incident.createdAt)</li>
    <li><a href="@routes.Incidents.edit(org.key, incident.id)">Edit</a> |
        <a href="@routes.Incidents.postDeleteById(org.key, incident.id)" class="delete" data-confirm="Are you sure to delete this incident?">Delete</a>
    </li>
  </ul>

  @incident.description.map { desc =>
    <div class="markdown">
      @Html(core.Markdown.toHtml(desc))
    </div>
  }

  <p><h2>Prevention Plan</h2></p>

  @if(plan.isEmpty) {
    <p><em>No plan</em></p>
    (<a href="@routes.Plans.uploadByIncidentId(org.key, incident.id)">Create</a> |
     <a href="@routes.Plans.postNoPlan(org.key, incident.id)" class="delete">Fail for Missing Plan</a>)
  } else {
    @if(plan.get.grade.isEmpty) {
      Rate this plan:
      <a href="@routes.Plans.postGrade(org.key, plan.get.id, lib.GradeImage.Good)" class="postForm">Good</a> |
      <a href="@routes.Plans.postGrade(org.key, plan.get.id, lib.GradeImage.Bad)" class="postForm">Bad</a>
    } else {
      @Html(lib.GradeImage.imageTag(incident.team, plan.get.grade))
      (<a href="#" onClick="$('#changeGrade').show()">change</a>)
      <div id="changeGrade" style="display: none">
        Rate this plan:
        <a href="@routes.Plans.postGrade(org.key, plan.get.id, lib.GradeImage.Good)" class="postForm">Good</a> |
        <a href="@routes.Plans.postGrade(org.key, plan.get.id, lib.GradeImage.Bad)" class="postForm">Bad</a>
      </div>
    }

    <div class="markdown">
      @Html(core.Markdown.toHtml(plan.get.body))
    </div>
    <p><em>Created: @_root_.org.joda.time.format.DateTimeFormat.longDateTime.print(plan.get.createdAt)</em></p>
    <p>
      <a href="@routes.Plans.uploadByIncidentId(org.key, incident.id)">Edit</a> |
      <a href="@routes.Plans.postDeleteById(org.key, plan.get.id, incident.id)" class="delete" data-confirm="Are you sure to delete this plan?">Delete</a>
    </p>
  }

  <p><h2>Meetings</h2></p>
  @if(meetings.isEmpty) {
    <em>No meetings</em>
  } else {
    <table>
      <tbody>
        @meetings.map { meeting =>
         <tr>
           <td><a href="@routes.Meetings.show(org.key, meeting.id)">@_root_.org.joda.time.format.DateTimeFormat.shortDate.print(meeting.scheduledAt)</a></td>
         </tr>
        }
      </tbody>
    </table>
  }

}
